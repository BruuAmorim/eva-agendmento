<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configurar Integra√ß√µes - EvAgendamento</title>

  <!-- Fonte -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .integrations-page {
      min-height: 100vh;
      background: var(--background);
    }

    .integrations-header {
      background: white;
      padding: 20px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .integrations-header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .integrations-header h1 {
      color: var(--text);
      margin: 0;
    }

    .integrations-main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .integration-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .integration-card h2 {
      margin: 0 0 20px 0;
      color: var(--text);
      font-size: 1.5rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text);
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-group .help-text {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 5px;
    }

    .form-group .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group .checkbox-group input[type="checkbox"] {
      width: auto;
    }

    .btn-test {
      background: var(--secondary);
      color: var(--text);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 10px;
      transition: background-color 0.2s;
    }

    .btn-test:hover {
      background: var(--secondary-dark);
    }

    .btn-save {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s;
    }

    .btn-save:hover {
      background: var(--primary-dark);
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-active {
      background: var(--success);
    }

    .status-inactive {
      background: var(--danger);
    }

    .test-result {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      display: none;
    }

    .test-result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .test-result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="integrations-header">
    <div class="integrations-header-content">
      <h1>üîó Configurar Integra√ß√µes</h1>
      <div>
        <a href="/admin/dashboard" class="admin-btn admin-btn-secondary" style="text-decoration: none; padding: 10px 20px; border-radius: 8px; background: var(--secondary); color: var(--text);">
          ‚Üê Voltar ao Dashboard
        </a>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="integrations-main">
    <!-- URL Base da API -->
    <div class="integration-card">
      <h2>üåê URL Base da API</h2>
      <p style="color: var(--muted); margin-bottom: 15px;">
        Use esta URL como refer√™ncia para configurar integra√ß√µes externas (n8n, webhooks, etc.).
      </p>

      <div class="form-group">
        <label>URL Base da API EvAgendamento</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="text" id="apiBaseUrl" readonly style="flex: 1; background: var(--background); border: 1px solid var(--border);">
          <button type="button" class="btn-test" id="copyApiUrlBtn" style="padding: 8px 12px; font-size: 14px;">üìã Copiar</button>
        </div>
        <div class="help-text">
          Esta √© a URL base oficial da API para integra√ß√µes externas
        </div>
      </div>

      <!-- Endpoints Principais -->
      <div style="margin-top: 20px;">
        <h4 style="color: var(--text); margin-bottom: 10px;">üìã Endpoints Principais:</h4>
        <div style="background: var(--background); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; line-height: 1.6;">
          <div><strong>GET</strong> /api/appointments/available/:date - Hor√°rios dispon√≠veis</div>
          <div><strong>POST</strong> /api/appointments - Criar agendamento</div>
          <div><strong>PUT</strong> /api/appointments/:id - Atualizar agendamento</div>
          <div><strong>DELETE</strong> /api/appointments/:id - Excluir agendamento</div>
          <div><strong>GET</strong> /api/health - Status da API</div>
        </div>
      </div>
    </div>

    <!-- Integra√ß√£o n8n -->
    <div class="integration-card">
      <h2>üîó Integra√ß√£o n8n</h2>
      <p style="color: var(--muted); margin-bottom: 25px;">
        Configure o webhook do n8n para receber notifica√ß√µes autom√°ticas sobre eventos de agendamentos.
      </p>

      <form id="n8nIntegrationForm">
        <div class="form-group">
          <label>URL do Webhook *</label>
          <input type="url" id="webhookUrl" placeholder="https://seu-n8n.com/webhook/evagendamento" required>
          <div class="help-text">
            URL completa do webhook criado no n8n para receber eventos
          </div>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="isActive">
            <label for="isActive" style="margin: 0; font-weight: normal;">
              <span class="status-indicator" id="statusIndicator"></span>
              Ativar integra√ß√£o
            </label>
          </div>
          <div class="help-text">
            Quando ativada, o sistema enviar√° eventos para o webhook configurado
          </div>
        </div>

        <div class="test-result" id="testResult"></div>

        <div style="margin-top: 25px;">
          <button type="button" class="btn-test" id="testWebhookBtn">üß™ Testar Conex√£o</button>
          <button type="submit" class="btn-save">üíæ Salvar Configura√ß√£o</button>
        </div>
      </form>
    </div>

    <!-- Informa√ß√µes sobre eventos -->
    <div class="integration-card">
      <h2>üìã Eventos Enviados</h2>
      <p style="color: var(--muted); margin-bottom: 15px;">
        O sistema envia automaticamente os seguintes eventos para o webhook:
      </p>
      <ul style="color: var(--text); line-height: 1.8;">
        <li><strong>appointment_created</strong> - Quando um novo agendamento √© criado</li>
        <li><strong>appointment_updated</strong> - Quando um agendamento √© atualizado</li>
        <li><strong>appointment_cancelled</strong> - Quando um agendamento √© cancelado</li>
        <li><strong>appointment_deleted</strong> - Quando um agendamento √© exclu√≠do</li>
      </ul>
    </div>
  </main>

  <!-- Scripts -->
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    // Gerenciamento de Integra√ß√µes
    class IntegrationManager {
      constructor() {
        this.init();
      }

      init() {
        this.checkAdminAccess();
        this.bindEvents();
        this.loadApiBaseUrl();
        this.loadIntegration();
      }

      checkAdminAccess() {
        if (!window.authManager || !window.authManager.isAdmin()) {
          window.location.href = '/';
          return;
        }
      }

      bindEvents() {
        // Formul√°rio de integra√ß√£o
        const form = document.getElementById('n8nIntegrationForm');
        if (form) {
          form.addEventListener('submit', (e) => this.saveIntegration(e));
        }

        // Bot√£o de teste
        const testBtn = document.getElementById('testWebhookBtn');
        if (testBtn) {
          testBtn.addEventListener('click', () => this.testWebhook());
        }

        // Bot√£o de c√≥pia da URL da API
        const copyBtn = document.getElementById('copyApiUrlBtn');
        if (copyBtn) {
          copyBtn.addEventListener('click', () => this.copyApiUrl());
        }
      }

      async       async loadApiBaseUrl() {
        try {
          // Buscar informa√ß√µes da API para obter a URL base
          const response = await window.authManager.apiRequest('/api/health');
          if (response.success) {
            const apiBaseUrlInput = document.getElementById('apiBaseUrl');
            if (apiBaseUrlInput) {
              apiBaseUrlInput.value = response.baseUrl || 'http://localhost:3000/api';
            }
          }
        } catch (error) {
          console.error('Erro ao carregar URL base da API:', error);
          // Fallback para URL padr√£o
          const apiBaseUrlInput = document.getElementById('apiBaseUrl');
          if (apiBaseUrlInput) {
            apiBaseUrlInput.value = 'http://localhost:3000/api';
          }
        }
      }

      loadIntegration() {
        try {
          const response = await window.authManager.apiRequest('/api/integrations');
          if (response.success && response.integration) {
            const integration = response.integration;

            document.getElementById('webhookUrl').value = integration.webhookUrl || '';
            document.getElementById('isActive').checked = integration.isActive || false;
            this.updateStatusIndicator();
          }
        } catch (error) {
          console.error('Erro ao carregar integra√ß√£o:', error);
          this.showToast('Erro ao carregar configura√ß√£o', 'error');
        }
      }

      updateStatusIndicator() {
        const indicator = document.getElementById('statusIndicator');
        const isActive = document.getElementById('isActive').checked;
        indicator.className = `status-indicator ${isActive ? 'status-active' : 'status-inactive'}`;
      }

      async saveIntegration(e) {
        e.preventDefault();

        const webhookUrl = document.getElementById('webhookUrl').value.trim();
        const isActive = document.getElementById('isActive').checked;

        if (!webhookUrl) {
          this.showToast('URL do webhook √© obrigat√≥ria', 'error');
          return;
        }

        try {
          const response = await window.authManager.apiRequest('/api/integrations', {
            method: 'PUT',
            body: JSON.stringify({ webhookUrl, isActive })
          });

          if (response.success) {
            this.showToast('Configura√ß√£o salva com sucesso!', 'success');
            this.updateStatusIndicator();
          } else {
            this.showToast(response.message || 'Erro ao salvar configura√ß√£o', 'error');
          }
        } catch (error) {
          console.error('Erro ao salvar integra√ß√£o:', error);
          this.showToast('Erro ao salvar configura√ß√£o', 'error');
        }
      }

      copyApiUrl() {
        const apiUrlInput = document.getElementById('apiBaseUrl');
        if (apiUrlInput) {
          apiUrlInput.select();
          apiUrlInput.setSelectionRange(0, 99999); // Para dispositivos m√≥veis

          try {
            document.execCommand('copy');
            this.showToast('URL da API copiada para a √°rea de transfer√™ncia!', 'success');
          } catch (error) {
            console.error('Erro ao copiar URL:', error);
            this.showToast('Erro ao copiar URL. Selecione e copie manualmente.', 'error');
          }
        }
      }

      async testWebhook() {
        const testResult = document.getElementById('testResult');
        testResult.className = 'test-result';
        testResult.textContent = 'Testando conex√£o...';

        const testBtn = document.getElementById('testWebhookBtn');
        testBtn.disabled = true;
        testBtn.textContent = 'Testando...';

        try {
          const response = await window.authManager.apiRequest('/api/integrations/test', {
            method: 'POST'
          });

          if (response.success) {
            testResult.className = 'test-result success';
            testResult.textContent = `‚úÖ ${response.message || 'Conex√£o testada com sucesso!'}`;
          } else {
            testResult.className = 'test-result error';
            testResult.textContent = `‚ùå ${response.message || 'Falha na conex√£o'}`;
          }
        } catch (error) {
          testResult.className = 'test-result error';
          testResult.textContent = `‚ùå Erro ao testar conex√£o: ${error.message || 'Erro desconhecido'}`;
        } finally {
          testBtn.disabled = false;
          testBtn.textContent = 'üß™ Testar Conex√£o';
        }
      }

      showToast(message, type = 'info') {
        if (window.authManager) {
          window.authManager.showToast(message, type);
        } else {
          alert(message);
        }
      }
    }

    // Inst√¢ncia global
    let integrationManager;

    // Inicializar quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
      integrationManager = new IntegrationManager();
      window.integrationManager = integrationManager;
      
      // Atualizar indicador de status quando checkbox mudar
      const isActiveCheckbox = document.getElementById('isActive');
      if (isActiveCheckbox) {
        isActiveCheckbox.addEventListener('change', () => {
          if (integrationManager) integrationManager.updateStatusIndicator();
        });
      }
    });
  </script>
</body>
</html>

